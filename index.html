<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sophia v11.2 - Assistente Pessoal</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#BB86FC">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üß†</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Fira+Code&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg-primary: #121212; 
            --bg-secondary: #1E1E1E; 
            --bg-tertiary: #2A2A2A; 
            --text-primary: #EAEAEA; 
            --text-secondary: #A0A0A0; 
            --accent-primary: #BB86FC; 
            --accent-secondary: #03DAC6; 
            --bot-msg-bg: #2A2A2A; 
            --user-msg-bg: linear-gradient(135deg, #712B75, #A020F0); 
            --font-main: 'Inter', sans-serif; 
            --shadow: 0 4px 20px rgba(0,0,0,0.3);
            --border-radius: 12px;
        }
        
        body.kai-theme { 
            --bg-primary: #0d0d0d; 
            --bg-secondary: #1a1a1a; 
            --text-primary: #00ff41; 
            --text-secondary: #8c8c8c; 
            --accent-primary: #00aaff; 
            --user-msg-bg: linear-gradient(135deg, #0055ff, #00aaff); 
            --font-main: 'Fira Code', monospace; 
        }
        
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html, body { 
            height: 100%; 
            margin: 0; 
            overflow: hidden; 
            font-family: var(--font-main); 
            background: var(--bg-primary); 
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* TELA DE INTRODU√á√ÉO */
        #intro-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100vh; 
            background: var(--bg-primary); 
            z-index: 2000; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            text-align: center; 
            padding: 20px; 
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }
        
        #intro-overlay.hiding {
            opacity: 0;
            transform: translateY(-30px);
            pointer-events: none;
        }
        
        .intro-content { 
            max-width: 90%;
            width: 100%;
            max-width: 400px;
            animation: fadeInUp 0.8s ease-out;
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .intro-content h1 { 
            font-size: clamp(1.8rem, 5vw, 2.5rem); 
            margin-bottom: 15px; 
            background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        } 
        
        .intro-content h1 span { 
            color: var(--accent-primary); 
            font-weight: 700;
        }
        
        .intro-content p { 
            color: var(--text-secondary); 
            margin-bottom: 25px; 
            line-height: 1.6;
            font-size: clamp(0.9rem, 2.5vw, 1rem);
        }
        
        .terms-container { 
            display: flex; 
            align-items: flex-start; 
            justify-content: center; 
            gap: 12px; 
            margin-bottom: 25px; 
            font-size: 0.85em; 
            text-align: left;
            flex-wrap: wrap;
        }
        
        #terms-checkbox { 
            width: 20px; 
            height: 20px; 
            margin-top: 2px;
            accent-color: var(--accent-primary);
        }
        
        .terms-container label {
            flex: 1;
            min-width: 200px;
        }
        
        .terms-container a {
            color: var(--accent-secondary);
            text-decoration: none;
            border-bottom: 1px solid transparent;
            transition: border-color 0.3s;
        }
        
        .terms-container a:hover {
            border-bottom-color: var(--accent-secondary);
        }
        
        #start-button { 
            background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary)); 
            color: white; 
            border: none; 
            padding: 15px 30px; 
            border-radius: var(--border-radius); 
            font-size: 1em; 
            font-weight: 600; 
            cursor: pointer; 
            opacity: 0.5; 
            pointer-events: none; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 200px;
        }
        
        #start-button:not(:disabled) { 
            opacity: 1; 
            pointer-events: auto; 
            transform: translateY(0);
        }
        
        #start-button:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }
        
        #start-button:not(:disabled):active {
            transform: translateY(0);
        }

        /* APLICA√á√ÉO PRINCIPAL */
        .app-container { 
            display: flex; 
            height: 100vh; 
            width: 100%; 
            opacity: 0; 
            visibility: hidden; 
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(20px);
        }
        
        .app-container.visible { 
            opacity: 1; 
            visibility: visible; 
            transform: translateY(0);
        }
        
        /* SIDEBAR - Mobile First */
        #sidebar { 
            width: 100vw;
            background: var(--bg-secondary); 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            border-right: 1px solid var(--bg-tertiary);
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 1000;
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
        }
        
        #sidebar.open { 
            transform: translateX(0);
        }
        
        .sidebar-header {
            margin-bottom: 30px;
            text-align: center;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--bg-tertiary);
        }
        
        .sidebar-header h2 {
            margin: 0;
            font-size: 1.5rem;
            background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .sidebar-nav { 
            flex-grow: 1; 
            overflow-y: auto; 
        }
        
        .sidebar-nav h3 { 
            color: var(--text-secondary); 
            font-size: 0.75em; 
            text-transform: uppercase; 
            letter-spacing: 1.5px; 
            margin: 25px 0 12px 0; 
            font-weight: 600;
        }
        
        .sidebar-nav button { 
            background: var(--bg-tertiary); 
            border: none; 
            width: 100%; 
            color: var(--text-primary); 
            text-align: left; 
            padding: 16px 20px; 
            font-size: 0.95em; 
            border-radius: var(--border-radius); 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
            font-family: var(--font-main); 
            margin-bottom: 10px;
            font-weight: 500;
        }
        
        .sidebar-nav button:hover, 
        .sidebar-nav button:focus { 
            background: var(--accent-primary); 
            color: #121212; 
            transform: translateX(4px);
        }
        
        .sidebar-nav button:active {
            transform: translateX(2px) scale(0.98);
        }
        
        /* CHAT PRINCIPAL */
        .main-chat { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            width: 100%;
            height: 100vh;
        }
        
        #header { 
            padding: 15px 20px; 
            background: var(--bg-secondary); 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            border-bottom: 1px solid var(--bg-tertiary);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            z-index: 100;
        }
        
        #menu-toggle { 
            background: none; 
            border: none; 
            color: var(--text-primary); 
            font-size: 1.8em; 
            cursor: pointer; 
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #menu-toggle:hover {
            background: var(--bg-tertiary);
        }
        
        #menu-toggle:active {
            transform: scale(0.9);
        }
        
        .header-title { 
            text-align: center; 
            flex-grow: 1; 
        }
        
        .header-title h2, .header-title p { 
            margin: 0; 
            line-height: 1.2; 
        } 
        
        .header-title h2 {
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .header-title p { 
            font-size: 0.8em; 
            color: var(--text-secondary); 
        }
        
        /* MENSAGENS */
        #messages { 
            flex: 1; 
            padding: 20px 15px; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
            gap: 20px;
            scroll-behavior: smooth;
        }
        
        #messages::-webkit-scrollbar {
            width: 4px;
        }
        
        #messages::-webkit-scrollbar-track {
            background: transparent;
        }
        
        #messages::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
            border-radius: 2px;
        }
        
        .message { 
            display: flex; 
            align-items: flex-end; 
            gap: 12px; 
            max-width: 85%;
            animation: messageSlideIn 0.4s ease-out;
        }
        
        @keyframes messageSlideIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .avatar { 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            font-weight: 600; 
            flex-shrink: 0; 
            background: var(--bg-tertiary);
            font-size: 0.9rem;
            border: 2px solid var(--bg-primary);
        }
        
        .bot .avatar.typing-avatar { 
            animation: pulse 1.5s infinite; 
        }
        
        @keyframes pulse { 
            0%, 100% { background-color: var(--bg-tertiary); } 
            50% { background-color: var(--accent-secondary); } 
        }
        
        .msg-content { 
            padding: 16px 20px; 
            border-radius: 20px;
            font-size: 0.95rem;
            line-height: 1.5;
            word-wrap: break-word;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .bot .msg-content { 
            background: var(--bot-msg-bg); 
            border-bottom-left-radius: 6px;
            border: 1px solid var(--bg-tertiary);
        }
        
        .user { 
            align-self: flex-end; 
            flex-direction: row-reverse; 
        } 
        
        .user .avatar { 
            background: var(--accent-primary); 
            color: #121212;
        } 
        
        .user .msg-content { 
            background: var(--user-msg-bg); 
            color: white; 
            border-bottom-right-radius: 6px;
        }
        
        /* INPUT AREA */
        #input-area { 
            display: flex; 
            gap: 12px; 
            padding: 15px 20px; 
            border-top: 1px solid var(--bg-tertiary);
            background: var(--bg-secondary);
            position: relative;
        }
        
        #input { 
            flex: 1; 
            padding: 15px 20px; 
            border: none; 
            outline: none; 
            background: var(--bg-primary); 
            color: var(--text-primary); 
            border-radius: 25px; 
            font-size: 1em; 
            font-family: var(--font-main);
            border: 2px solid var(--bg-tertiary);
            transition: all 0.3s;
        }
        
        #input:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(187, 134, 252, 0.1);
        }
        
        #input::placeholder {
            color: var(--text-secondary);
        }
        
        #send { 
            background: var(--accent-primary); 
            border: none; 
            padding: 15px 20px; 
            cursor: pointer; 
            color: white; 
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #send:hover {
            background: var(--accent-secondary);
            transform: translateY(-1px);
        }
        
        #send:active {
            transform: translateY(0) scale(0.95);
        }
        
        /* API CARDS */
        .api-card {
            display: flex !important;
            gap: 12px !important;
            margin: 15px 0 !important;
            padding: 15px !important;
            background: var(--bg-tertiary) !important;
            border-radius: var(--border-radius) !important;
            border: 1px solid rgba(255,255,255,0.1) !important;
            transition: all 0.3s !important;
        }
        
        .api-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        .api-card img {
            width: 60px !important;
            height: 60px !important;
            object-fit: cover !important;
            border-radius: 8px !important;
            border: 1px solid var(--bg-tertiary) !important;
        }
        
        .api-card div {
            display: flex !important;
            flex-direction: column !important;
            justify-content: space-between !important;
            flex: 1 !important;
        }
        
        .api-card strong {
            font-weight: 600 !important;
            margin-bottom: 8px !important;
            display: block !important;
        }
        
        .api-card a {
            color: var(--accent-secondary) !important;
            text-decoration: none !important;
            font-size: 0.9em !important;
            font-weight: 500 !important;
            transition: color 0.3s !important;
        }
        
        .api-card a:hover {
            color: var(--accent-primary) !important;
        }
        
        /* OVERLAY PARA SIDEBAR MOBILE */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        /* RESPONSIVIDADE TABLET */
        @media (min-width: 768px) {
            .intro-content {
                max-width: 500px;
            }
            
            .terms-container {
                text-align: center;
            }
            
            #sidebar {
                width: 320px;
                position: relative;
                transform: translateX(0);
                height: auto;
            }
            
            #menu-toggle {
                display: none;
            }
            
            .message {
                max-width: 70%;
            }
            
            #messages {
                padding: 25px 30px;
            }
            
            #input-area {
                padding: 20px 30px;
            }
        }
        
        /* RESPONSIVIDADE DESKTOP */
        @media (min-width: 1024px) {
            #sidebar {
                width: 350px;
            }
            
            .message {
                max-width: 60%;
            }
            
            #messages {
                padding: 30px 40px;
                gap: 25px;
            }
            
            .msg-content {
                font-size: 1rem;
                padding: 18px 24px;
            }
            
            #input-area {
                padding: 25px 40px;
                gap: 15px;
            }
            
            #input, #send {
                padding: 18px 24px;
            }
        }
        
        /* MELHORIAS PARA TOUCH */
        @media (hover: none) {
            .sidebar-nav button:hover {
                background: var(--bg-tertiary);
                color: var(--text-primary);
                transform: none;
            }
            
            .sidebar-nav button:active {
                background: var(--accent-primary);
                color: #121212;
            }
            
            #send:hover {
                background: var(--accent-primary);
                transform: none;
            }
        }
    </style>
</head>
<body>
    <!-- TELA DE INTRODU√á√ÉO -->
    <div id="intro-overlay">
        <div class="intro-content">
            <h1>‚ú¶<span>Sophia</span>‚ú¶</h1>
            <p>Sua assistente pessoal com mem√≥ria e aprendizado. Suas conversas e dados s√£o salvos localmente no seu navegador para total privacidade.</p>
            <div class="terms-container">
                <input type="checkbox" id="terms-checkbox">
                <label for="terms-checkbox">Eu li e aceito os <a href="https://naotodev1.github.io/terms-e-policy/" target="_blank">Termos de Uso e Pol√≠tica de Privacidade</a></label>
            </div>
            <button id="start-button" disabled>Come√ßar</button>
        </div>
    </div>

    <!-- OVERLAY PARA SIDEBAR MOBILE -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <!-- APLICA√á√ÉO PRINCIPAL -->
    <div class="app-container" id="app-container">
        <aside id="sidebar">
            <div class="sidebar-header">
                <h2 id="sidebar-name">‚ú¶<span>SOPHIA</span>‚ú¶</h2>
            </div>
            <nav class="sidebar-nav" id="sidebar-nav">
                <!-- Conte√∫do ser√° inserido via JS -->
            </nav>
        </aside>
        
        <main class="main-chat">
            <div id="header">
                <button id="menu-toggle" aria-label="Menu">&#9776;</button>
                <div class="header-title">
                    <h2 id="header-name">Sophia</h2>
                    <p id="header-subtitle">v11.2</p>
                </div>
            </div>
            <div id="messages"></div>
            <div id="input-area">
                <input type="text" id="input" placeholder="Digite sua mensagem..." />
                <button id="send">Enviar</button>
            </div>
        </main>
    </div>

    <script>
        // --- 1. CONFIGURA√á√ÉO E VARI√ÅVEIS GLOBAIS ---
        let appState = {};
        let domElements = {};

        // ‚ùó‚ùó‚ùó CHAVE DA API GNEWS AQUI ‚ùó‚ùó‚ùó
        const NEWS_API_KEY = 'SUA_CHAVE_DE_API_AQUI';

        // --- 2. MEM√ìRIA E ESTADO ---
        const defaultMemory = {
            botProfile: { name: 'Sophia', mode: 'sophia' },
            userProfile: { name: null, acceptedTerms: false },
            knowledge: { 'sophia': 'uma assistente virtual.' },
            conversations: []
        };

        function loadMemory() {
            try {
                const saved = localStorage.getItem('SOPHIA_MEMORY_V11');
                appState.memory = saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(defaultMemory));
            } catch (error) {
                console.error('Erro ao carregar mem√≥ria:', error);
                appState.memory = JSON.parse(JSON.stringify(defaultMemory));
            }
        }

        function saveMemory() {
            try {
                localStorage.setItem('SOPHIA_MEMORY_V11', JSON.stringify(appState.memory));
            } catch (error) {
                console.error('Erro ao salvar mem√≥ria:', error);
            }
        }
        
        // --- 3. C√âREBRO (L√ìGICA PRINCIPAL) ---
        const brain = {
            getResponse: async function(userText) {
                const text = userText.toLowerCase().trim();
                const { mode } = appState.memory.botProfile;

                // Comandos Globais
                if (text === 'ativar modo kai') return { response: 'RESPONSE_TYPE_KAI_ON' };
                if (text === 'sair do modo kai' || text === 'voltar para sophia') return { response: 'RESPONSE_TYPE_KAI_OFF' };
                
                const renameMatch = text.match(/^renomear para (.+)/);
                if (renameMatch) {
                    const newName = renameMatch[1].trim();
                    appState.memory.botProfile.name = newName;
                    saveMemory();
                    return { response: `Entendido! A partir de agora, meu nome √© **${newName}**. ‚ú®` };
                }
                
                const learnMatch = text.match(/^(?:lembre-se que|aprenda que) (.+?) (?:√©|sou|s√£o) (.+)/);
                if (learnMatch) return this.handleSemanticLearning(learnMatch);

                const personality = mode === 'kai' ? this.kai : this.sophia;
                return await personality.getResponse(text);
            },

            handleSemanticLearning: async (match) => {
                const term = match[1].trim().toLowerCase();
                const relationship = match[2].trim();
                appState.memory.knowledge[term] = relationship;
                saveMemory();
                return { response: `‚úÖ Entendido! Aprendi que **${term}** √© ${relationship}.` };
            },
            
            sophia: {
                getResponse: async function(text) {
                    const commands = [
                        { p: /^(?:o que significa|defina|defini√ß√£o de) (.+)/, h: this.getDefinition },
                        { p: /^not√≠cias(?: sobre (.+))?/, h: this.getNews },
                        { p: /^(?:o que √©|quem √©|me fale sobre) (.+)\??/, h: this.getKnowledge },
                        { p: /^limpar mem√≥ria/, h: this.clearMemory },
                    ];
                    
                    for (const cmd of commands) {
                        const match = text.match(cmd.p);
                        if (match) return await cmd.h(match);
                    }
                    
                    // Respostas contextuais
                    if (text.includes('ajuda') || text.includes('comandos')) {
                        return { response: `ü§ñ **Comandos dispon√≠veis:**\n\nüì∞ **not√≠cias** - √öltimas not√≠cias\nüìñ **o que significa [palavra]** - Defini√ß√µes\nüß† **aprenda que [termo] √© [defini√ß√£o]** - Ensinar algo novo\nüîß **ativar modo kai** - Ambiente t√©cnico\n\nPara mais op√ß√µes, explore o menu lateral! üëà` };
                    }
                    
                    if (text.includes('oi') || text.includes('ol√°') || text.includes('ola') || text === 'e ai' || text === 'eai') {
                        const greeting = this.getRandomGreeting();
                        return { response: `${greeting} ${appState.memory.userProfile.name || 'usu√°rio'}! üòä\n\nComo posso te ajudar hoje?` };
                    }
                    
                    if (text.includes('tchau') || text.includes('at√©') || text.includes('bye')) {
                        return { response: `At√© mais, ${appState.memory.userProfile.name || 'usu√°rio'}! üëã Foi um prazer te ajudar hoje!` };
                    }
                    
                    if (text.includes('como voc√™ est√°') || text.includes('como vai')) {
                        return { response: `Estou funcionando perfeitamente! üíú Pronta para te ajudar com o que precisar. E voc√™, como est√°?` };
                    }
                    
                    if (text.includes('obrigado') || text.includes('obrigada') || text.includes('valeu')) {
                        return { response: `Por nada! üòä Fico feliz em poder ajudar. Se precisar de mais alguma coisa, √© s√≥ falar!` };
                    }
                    
                    // Resposta padr√£o mais amig√°vel
                    const suggestions = [
                        "Tente perguntar sobre **not√≠cias** üì∞",
                        "Pe√ßa uma **defini√ß√£o** de alguma palavra üìñ", 
                        "Digite **ajuda** para ver todos os comandos ü§ñ",
                        "Explore o menu lateral para mais op√ß√µes üëà"
                    ];
                    const randomSuggestion = suggestions[Math.floor(Math.random() * suggestions.length)];
                    
                    return { response: `ü§î Hmm, n√£o entendi muito bem. ${randomSuggestion}` };
                },

                getRandomGreeting: function() {
                    const greetings = ["Ol√°", "Oi", "E a√≠", "Opa", "Hey"];
                    return greetings[Math.floor(Math.random() * greetings.length)];
                },
                
                getNews: async (match) => {
                    if (!NEWS_API_KEY || NEWS_API_KEY === 'SUA_CHAVE_DE_API_AQUI') {
                        return { response: "‚ö†Ô∏è A fun√ß√£o de not√≠cias est√° desativada. Configure sua chave de API para ativar esta funcionalidade." };
                    }
                    
                    const query = match[1] || 'general';
                    
                    try {
                        const response = await fetch(`https://gnews.io/api/v4/top-headlines?lang=pt&topic=${encodeURIComponent(query)}&token=${NEWS_API_KEY}`);
                        
                        if (!response.ok) {
                            throw new Error(`API Error: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        
                        if (!data.articles || data.articles.length === 0) {
                            return { response: `üì∞ N√£o encontrei not√≠cias sobre "${query}" no momento.` };
                        }
                        
                        let html = `üì∞ **Principais not√≠cias sobre "${query}":**\n\n`;
                        
                        data.articles.slice(0, 3).forEach((article, index) => { 
                            html += `<div class="api-card"><img src="${article.image || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjMkEyQTJBIi8+Cjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkb21pbmFudC1iYXNlbGluZT0iY2VudHJhbCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzY2NjY2NiIgZm9udC1zaXplPSIyNCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiPvCfk7A8L3RleHQ+Cjwvc3ZnPgo='}" alt="Not√≠cia"><div><strong>${article.title}</strong><a href="${article.url}" target="_blank">Ler mat√©ria completa üìñ</a></div></div>`; 
                        });
                        
                        return { response: html };
                    } catch (error) { 
                        console.error('Erro ao buscar not√≠cias:', error);
                        return { response: `‚ùå Erro ao buscar not√≠cias. Tente novamente em alguns minutos.` }; 
                    }
                },
                
                getDefinition: async (match) => {
                    const word = match[1].trim().toLowerCase();
                    
                    try {
                        const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/pt-BR/${encodeURIComponent(word)}`);
                        
                        if (!response.ok) {
                            throw new Error('Palavra n√£o encontrada');
                        }
                        
                        const data = await response.json();
                        const entry = data[0];
                        const meaning = entry.meanings[0].definitions[0];
                        
                        let result = `üìñ **${word.charAt(0).toUpperCase() + word.slice(1)}**\n\n`;
                        result += `**Defini√ß√£o:** ${meaning.definition}`;
                        
                        if (meaning.example) {
                            result += `\n\n**Exemplo:** *"${meaning.example}"*`;
                        }
                        
                        if (entry.phonetics && entry.phonetics[0] && entry.phonetics[0].text) {
                            result += `\n\n**Pron√∫ncia:** ${entry.phonetics[0].text}`;
                        }
                        
                        return { response: result };
                    } catch (error) { 
                        return { response: `‚ùå N√£o encontrei uma defini√ß√£o para "${word}". Tente com outra palavra ou verifique a ortografia.` }; 
                    }
                },
                
                getKnowledge: async (match) => {
                    const concept = match[1].trim().toLowerCase();
                    const knowledge = appState.memory.knowledge[concept];
                    
                    if (knowledge) {
                        return { response: `üß† Pelo que aprendi, **${concept}** √© ${knowledge}.` };
                    } else {
                        return { response: `ü§î Ainda n√£o aprendi sobre **${concept}**. Voc√™ pode me ensinar usando:\n\n*"aprenda que ${concept} √© [sua defini√ß√£o]"*` };
                    }
                },
                
                clearMemory: async () => {
                    if (confirm("‚ö†Ô∏è Voc√™ tem certeza que quer excluir todos os seus dados?\n\nIsso apagar√°:\n‚Ä¢ Suas conversas\n‚Ä¢ Conhecimentos aprendidos\n‚Ä¢ Configura√ß√µes pessoais\n\nEsta a√ß√£o n√£o pode ser desfeita.")) {
                        localStorage.removeItem('SOPHIA_MEMORY_V11'); 
                        loadMemory();
                        UI.renderSidebar();
                        return { response: "üîÑ Mem√≥ria limpa com sucesso! Come√ßando do zero." };
                    } 
                    return { response: "‚ùå A√ß√£o cancelada. Seus dados est√£o seguros." };
                },
            },
            
            kai: {
                getResponse: async function(text) {
                    if (text.includes('ajuda') || text.includes('comandos')) {
                        return { response: "üöÄ **SISTEMA KAI ATIVO**\n\n```\n‚Ä¢ doc javascript [t√≥pico]    - Documenta√ß√£o JS\n‚Ä¢ gere html b√°sico            - Template HTML\n‚Ä¢ sair do modo kai           - Retornar √† Sophia\n```\n\n**STATUS:** Todos os sistemas operacionais." };
                    }
                    
                    if (text.includes('oi') || text.includes('ol√°')) {
                        return { response: "```\n[KAI] Sistemas online.\n[KAI] Aguardando diretiva...\n```\n\nDigite `ajuda` para comandos dispon√≠veis." };
                    }
                    
                    if (text.includes('gere html b√°sico') || text.includes('html basico')) {
                        return { 
                            response: "```html\n<!DOCTYPE html>\n<html lang=\"pt-BR\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Documento</title>\n</head>\n<body>\n    <h1>Ol√°, Mundo!</h1>\n    <p>Documento HTML b√°sico gerado pelo KAI.</p>\n</body>\n</html>\n```" 
                        };
                    }
                    
                    if (text.startsWith('doc javascript') || text.startsWith('doc js')) {
                        const topic = text.replace(/^doc(?:umentation)?\s+(?:javascript|js)\s*/, '').trim();
                        return this.getJSDoc(topic);
                    }
                    
                    return { response: "```\n[KAI] Comando n√£o reconhecido.\n[ERROR] Digite 'ajuda' para lista de comandos.\n```" };
                },
                
                getJSDoc: function(topic) {
                    const docs = {
                        'array': "```javascript\n// M√âTODOS DE ARRAY ESSENCIAIS\nconst arr = [1, 2, 3, 4, 5];\n\n// Adicionar elementos\narr.push(6);           // [1,2,3,4,5,6]\narr.unshift(0);        // [0,1,2,3,4,5,6]\n\n// Remover elementos\narr.pop();             // Remove √∫ltimo\narr.shift();           // Remove primeiro\n\n// Buscar elementos\narr.find(x => x > 3);  // 4 (primeiro encontrado)\narr.filter(x => x > 3); // [4, 5] (todos)\n\n// Transformar\narr.map(x => x * 2);   // [2,4,6,8,10]\narr.reduce((a,b) => a+b, 0); // 15 (soma)\n```",
                        
                        'function': "```javascript\n// TIPOS DE FUN√á√ÉO\n\n// Fun√ß√£o declarada\nfunction soma(a, b) {\n    return a + b;\n}\n\n// Fun√ß√£o expressa\nconst multiplicar = function(a, b) {\n    return a * b;\n};\n\n// Arrow function\nconst dividir = (a, b) => a / b;\n\n// Fun√ß√£o ass√≠ncrona\nasync function buscarDados() {\n    const response = await fetch('/api/dados');\n    return response.json();\n}\n```",
                        
                        'object': "```javascript\n// MANIPULA√á√ÉO DE OBJETOS\n\nconst usuario = {\n    nome: 'Jo√£o',\n    idade: 30,\n    email: 'joao@email.com'\n};\n\n// Acessar propriedades\nconsole.log(usuario.nome);     // Jo√£o\nconsole.log(usuario['idade']); // 30\n\n// Adicionar propriedades\nusuario.telefone = '123456789';\n\n// Desestrutura√ß√£o\nconst { nome, idade } = usuario;\n\n// Object methods\nObject.keys(usuario);    // ['nome', 'idade', 'email']\nObject.values(usuario);  // ['Jo√£o', 30, 'joao@email.com']\nObject.entries(usuario); // [['nome', 'Jo√£o'], ...]\n```",
                        
                        'promise': "```javascript\n// PROMISES E ASYNC/AWAIT\n\n// Criando uma Promise\nconst minhaPromise = new Promise((resolve, reject) => {\n    setTimeout(() => {\n        resolve('Sucesso!');\n    }, 1000);\n});\n\n// Usando .then()\nminhaPromise\n    .then(resultado => console.log(resultado))\n    .catch(erro => console.error(erro));\n\n// Usando async/await\nasync function exemploAsync() {\n    try {\n        const resultado = await minhaPromise;\n        console.log(resultado);\n    } catch (erro) {\n        console.error(erro);\n    }\n}\n```"
                    };
                    
                    const doc = docs[topic.toLowerCase()];
                    if (doc) {
                        return { response: `üìö **Documenta√ß√£o JavaScript: ${topic.toUpperCase()}**\n\n${doc}` };
                    } else {
                        const available = Object.keys(docs).join(', ');
                        return { response: ````\n[KAI] T√≥pico '${topic}' n√£o encontrado.\n[INFO] T√≥picos dispon√≠veis: ${available}\n```` };
                    }
                }
            }
        };

        // --- 4. M√ìDULO DE UI ---
        const UI = {
            initElements: function() {
                // Elementos da introdu√ß√£o
                domElements.introOverlay = document.getElementById('intro-overlay');
                domElements.termsCheckbox = document.getElementById('terms-checkbox');
                domElements.startButton = document.getElementById('start-button');
                domElements.appContainer = document.getElementById('app-container');
                
                // Elementos da aplica√ß√£o principal
                domElements.sidebar = document.getElementById('sidebar');
                domElements.sidebarNav = document.getElementById('sidebar-nav');
                domElements.sidebarOverlay = document.getElementById('sidebar-overlay');
                domElements.menuToggle = document.getElementById('menu-toggle');
                domElements.messagesContainer = document.getElementById("messages");
                domElements.inputField = document.getElementById("input");
                domElements.sendButton = document.getElementById("send");
                domElements.headerName = document.getElementById('header-name');
                domElements.headerSubtitle = document.getElementById('header-subtitle');
            },

            initApp: function() {
                // Eventos de navega√ß√£o
                domElements.menuToggle.addEventListener('click', this.toggleSidebar);
                domElements.sidebarOverlay.addEventListener('click', this.closeSidebar);
                
                // Eventos de chat
                domElements.sendButton.addEventListener('click', () => handleSend());
                domElements.inputField.addEventListener('keypress', (e) => { 
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        handleSend(); 
                    }
                });
                
                // Eventos de introdu√ß√£o
                domElements.termsCheckbox.addEventListener('change', () => { 
                    domElements.startButton.disabled = !domElements.termsCheckbox.checked; 
                });
                domElements.startButton.addEventListener('click', this.startApp);
                
                // Fechar sidebar ao clicar em link mobile
                document.addEventListener('click', (e) => {
                    if (window.innerWidth < 768 && e.target.closest('.sidebar-nav button')) {
                        this.closeSidebar();
                    }
                });
                
                // Resize handler
                window.addEventListener('resize', this.handleResize);
            },
            
            handleResize: function() {
                if (window.innerWidth >= 768) {
                    UI.closeSidebar();
                }
            },
            
            toggleSidebar: function() {
                domElements.sidebar.classList.toggle('open');
                domElements.sidebarOverlay.classList.toggle('active');
            },
            
            closeSidebar: function() {
                domElements.sidebar.classList.remove('open');
                domElements.sidebarOverlay.classList.remove('active');
            },

            startApp: function() {
                appState.memory.userProfile.acceptedTerms = true;
                
                if (!appState.memory.userProfile.name) {
                    const name = prompt("üéâ Bem-vindo(a)! Como posso te chamar?");
                    if (name && name.trim()) {
                        appState.memory.userProfile.name = name.trim();
                    }
                }
                
                saveMemory();
                
                // Anima√ß√£o de sa√≠da da intro
                domElements.introOverlay.classList.add('hiding');
                
                setTimeout(() => {
                    domElements.introOverlay.style.display = 'none';
                    domElements.appContainer.classList.add('visible');
                    UI.renderSidebar();
                    UI.updateHeader();
                    
                    // Mensagem de boas-vindas
                    const welcomeMsg = appState.memory.userProfile.name ? 
                        `Ol√°, **${appState.memory.userProfile.name}**! üëã\n\nSou a Sophia, sua assistente pessoal. Estou aqui para te ajudar com not√≠cias, defini√ß√µes, e muito mais!\n\nüí° **Dica:** Explore o menu lateral para descobrir todas as funcionalidades.` :
                        `Ol√°! üëã Sou a Sophia, sua assistente pessoal.\n\nEstou aqui para te ajudar com not√≠cias, defini√ß√µes e muito mais!\n\nüí° **Dica:** Digite **ajuda** para ver os comandos dispon√≠veis.`;
                    
                    UI.addMessage(welcomeMsg, 'bot');
                    
                    // Focus no input para melhor UX
                    if (window.innerWidth >= 768) {
                        domElements.inputField.focus();
                    }
                }, 600);
            },
            
            renderSidebar: function() {
                const kaiButton = appState.memory.botProfile.mode === 'kai' ? 
                    `<button data-command="sair do modo kai">üîô Sair do Modo KAI</button>` :
                    `<button data-command="ativar modo kai">üöÄ Ativar Modo KAI</button>`;
                
                domElements.sidebarNav.innerHTML = `
                    <h3>üí¨ Conversa√ß√£o</h3>
                    <button data-command="ajuda">‚ùì Ajuda & Comandos</button>
                    <button data-command="oi">üëã Cumprimentar</button>
                    
                    <h3>üîß Funcionalidades</h3>
                    <button data-command="not√≠cias">üì∞ Not√≠cias do Brasil</button>
                    <button data-command="o que significa intelig√™ncia artificial">üìñ Defini√ß√µes</button>
                    <button onclick="UI.showLearnDialog()">üß† Ensinar Algo</button>
                    
                    <h3>‚öôÔ∏è Sistema</h3>
                    ${kaiButton}
                    <button onclick="UI.showRenameDialog()">‚úèÔ∏è Renomear Assistente</button>
                    
                    <h3>üë§ Conta</h3>
                    <button onclick="UI.exportData()">üì• Exportar Dados</button>
                    <button onclick="UI.deleteAccount()">‚ùå Excluir Conta</button>
                `;
                
                // Adicionar eventos aos bot√µes
                domElements.sidebarNav.querySelectorAll('button[data-command]').forEach(btn => {
                    btn.addEventListener('click', () => handleSend(btn.dataset.command));
                });
            },
            
            showLearnDialog: function() {
                const concept = prompt("üß† O que voc√™ quer me ensinar?\n\nFormato: [termo] √© [defini√ß√£o]\nExemplo: programa√ß√£o √© o processo de criar software");
                if (concept && concept.trim()) {
                    handleSend(`aprenda que ${concept.trim()}`);
                }
            },
            
            showRenameDialog: function() {
                const currentName = appState.memory.botProfile.name;
                const newName = prompt(`‚úèÔ∏è Digite o novo nome da assistente:\n\nNome atual: ${currentName}`);
                if (newName && newName.trim() && newName.trim() !== currentName) {
                    handleSend(`renomear para ${newName.trim()}`);
                }
            },
            
            updateHeader: function() {
                domElements.headerName.textContent = appState.memory.botProfile.name;
                domElements.headerSubtitle.textContent = `Modo ${appState.memory.botProfile.mode.charAt(0).toUpperCase() + appState.memory.botProfile.mode.slice(1)} ‚Ä¢ v11.2`;
            },
            
            addMessage: function(text, sender) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
                
                const avatarChar = sender === 'user' ? 
                    (appState.memory.userProfile.name ? appState.memory.userProfile.name.charAt(0).toUpperCase() : 'U') : 
                    (appState.memory.botProfile.mode === 'kai' ? 'K' : appState.memory.botProfile.name.charAt(0).toUpperCase());
                
                const processedText = text
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                    .replace(/`(.*?)`/g, '<code>$1</code>')
                    .replace(/\n/g, '<br>');
                
                messageDiv.innerHTML = `
                    <div class="avatar">${avatarChar}</div>
                    <div class="msg-content">${processedText}</div>
                `;
                
                domElements.messagesContainer.appendChild(messageDiv);
                domElements.messagesContainer.scrollTop = domElements.messagesContainer.scrollHeight;
                
                // Salvar mensagem na mem√≥ria
                appState.memory.conversations.push({
                    sender: sender,
                    text: text,
                    timestamp: Date.now()
                });
                
                // Limitar hist√≥rico a 100 mensagens
                if (appState.memory.conversations.length > 100) {
                    appState.memory.conversations = appState.memory.conversations.slice(-100);
                }
                
                saveMemory();
            },
            
            exportData: function() {
                const data = {
                    exportDate: new Date().toISOString(),
                    version: 'v11.2',
                    ...appState.memory
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `sophia_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                UI.addMessage("üì• **Dados exportados com sucesso!**\n\nO arquivo foi baixado para seu dispositivo. Mantenha-o em local seguro para fazer backup de suas conversas e configura√ß√µes.", 'bot');
            },
            
            deleteAccount: function() {
                const confirmed = confirm(
                    "‚ö†Ô∏è ATEN√á√ÉO: EXCLUS√ÉO PERMANENTE DE CONTA\n\n" +
                    "Esta a√ß√£o ir√° EXCLUIR PERMANENTEMENTE:\n" +
                    "‚Ä¢ Todas as suas conversas\n" +
                    "‚Ä¢ Conhecimentos ensinados √† IA\n" +
                    "‚Ä¢ Configura√ß√µes personalizadas\n" +
                    "‚Ä¢ Dados do usu√°rio\n\n" +
                    "‚ùå ESTA A√á√ÉO N√ÉO PODE SER DESFEITA!\n\n" +
                    "Tem certeza absoluta que deseja continuar?"
                );
                
                if (confirmed) {
                    const doubleConfirm = confirm(
                        "üö® √öLTIMA CONFIRMA√á√ÉO\n\n" +
                        "Voc√™ est√° prestes a excluir TODOS os seus dados.\n\n" +
                        "Digite 'CONFIRMAR' no pr√≥ximo di√°logo para prosseguir:"
                    );
                    
                    if (doubleConfirm) {
                        const finalConfirm = prompt("Digite 'CONFIRMAR' (em mai√∫sculas) para excluir sua conta:");
                        
                        if (finalConfirm === 'CONFIRMAR') {
                            localStorage.removeItem('SOPHIA_MEMORY_V11');
                            alert("‚úÖ Conta exclu√≠da com sucesso.\n\nTodos os seus dados foram removidos permanentemente.\n\nA p√°gina ser√° recarregada.");
                            location.reload();
                        } else {
                            UI.addMessage("‚ùå **Exclus√£o de conta cancelada.**\n\nSeus dados est√£o seguros e nenhuma altera√ß√£o foi feita.", 'bot');
                        }
                    } else {
                        UI.addMessage("‚ùå **Exclus√£o de conta cancelada.**\n\nSeus dados est√£o seguros.", 'bot');
                    }
                } else {
                    UI.addMessage("‚ùå **Exclus√£o de conta cancelada.**\n\nSeus dados permanecem intactos.", 'bot');
                }
            }
        };
        
        // --- 5. MANIPULA√á√ÉO DE ENVIO DE MENSAGENS ---
        async function handleSend(prefilledText) {
            const userText = typeof prefilledText === 'string' ? prefilledText : domElements.inputField.value.trim();
            if (!userText) return;

            UI.addMessage(userText, 'user');
            if (typeof prefilledText !== 'string') {
                domElements.inputField.value = '';
            }
            
            // Feedback visual de digita√ß√£o
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot';
            typingDiv.innerHTML = `
                <div class="avatar typing-avatar">${appState.memory.botProfile.mode === 'kai' ? 'K' : appState.memory.botProfile.name.charAt(0).toUpperCase()}</div>
                <div class="msg-content">Digitando...</div>
            `;
            domElements.messagesContainer.appendChild(typingDiv);
            domElements.messagesContainer.scrollTop = domElements.messagesContainer.scrollHeight;
            
            try {
                const botPayload = await brain.getResponse(userText);
                
                // Remover indicador de digita√ß√£o
                domElements.messagesContainer.removeChild(typingDiv);
                
                // L√≥gica para tratar respostas especiais
                if (botPayload.response === 'RESPONSE_TYPE_KAI_ON') {
                    appState.memory.botProfile.mode = 'kai'; 
                    saveMemory(); 
                    UI.updateHeader();
                    UI.renderSidebar();
                    document.body.classList.add('kai-theme');
                    UI.addMessage("üöÄ **SISTEMA KAI ATIVADO**\n\n```\n[KAI] Todos os sistemas online\n[KAI] Modo t√©cnico habilitado\n[KAI] Digite 'ajuda' para comandos\n```", 'bot');
                } else if (botPayload.response === 'RESPONSE_TYPE_KAI_OFF') {
                    appState.memory.botProfile.mode = 'sophia'; 
                    saveMemory(); 
                    UI.updateHeader();
                    UI.renderSidebar();
                    document.body.classList.remove('kai-theme');
                    UI.addMessage("üíú **Voltando ao modo Sophia**\n\nOl√° novamente! Como posso te ajudar de forma mais amig√°vel? üòä", 'bot');
                } else {
                    UI.addMessage(botPayload.response, 'bot');
                }
            } catch (error) {
                // Remover indicador de digita√ß√£o
                domElements.messagesContainer.removeChild(typingDiv);
                console.error('Erro ao processar mensagem:', error);
                UI.addMessage("‚ùå Ops! Ocorreu um erro inesperado. Tente novamente.", 'bot');
            }
        }

        // --- 6. INICIALIZA√á√ÉO ---
        window.addEventListener('DOMContentLoaded', () => {
            loadMemory();
            UI.initElements();
            UI.initApp();
            
            // Se j√° aceitou os termos, ir direto para a app
            if (appState.memory.userProfile.acceptedTerms) {
                UI.startApp();
            }
        });

        // --- 7. SERVICE WORKER (PWA) ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => console.log('‚úÖ Service Worker registrado:', registration.scope))
                    .catch(error => console.log('‚ùå Service Worker erro:', error));
            });
        }

        // --- 8. MELHORIAS DE PERFORMANCE ---
        // Debounce para resize
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(UI.handleResize, 250);
        });

        // Prevenir zoom duplo toque no iOS
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    </script>
</body>
</html>
