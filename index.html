<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sophia v11.2 - Assistente Pessoal</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#BB86FC">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üß†</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Fira+Code&display=swap" rel="stylesheet">
    <style>
        :root { --bg-primary: #121212; --bg-secondary: #1E1E1E; --bg-tertiary: #2A2A2A; --text-primary: #EAEAEA; --text-secondary: #A0A0A0; --accent-primary: #BB86FC; --accent-secondary: #03DAC6; --bot-msg-bg: #2A2A2A; --user-msg-bg: linear-gradient(135deg, #712B75, #A020F0); --font-main: 'Inter', sans-serif; }
        body.kai-theme { --bg-primary: #0d0d0d; --bg-secondary: #1a1a1a; --text-primary: #00ff41; --text-secondary: #8c8c8c; --accent-primary: #00aaff; --user-msg-bg: linear-gradient(135deg, #0055ff, #00aaff); --font-main: 'Fira Code', monospace; }
        
        html, body { height: 100%; margin: 0; overflow: hidden; font-family: var(--font-main); background: var(--bg-primary); color: var(--text-primary); }
        
        #intro-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-primary); z-index: 2000; display: flex; justify-content: center; align-items: center; text-align: center; padding: 20px; transition: opacity 0.5s ease-out; }
        .intro-content { max-width: 500px; }
        .intro-content h1 { font-size: 2.5em; margin-bottom: 10px; } .intro-content h1 span { color: var(--accent-primary); }
        .intro-content p { color: var(--text-secondary); margin-bottom: 20px; }
        .terms-container { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 20px; font-size: 0.9em; }
        #terms-checkbox { width: 18px; height: 18px; }
        #start-button { background: var(--accent-primary); color: white; border: none; padding: 12px 25px; border-radius: 8px; font-size: 1em; font-weight: 500; cursor: pointer; opacity: 0.5; pointer-events: none; transition: opacity 0.3s; }
        #start-button:not(:disabled) { opacity: 1; pointer-events: auto; }

        .app-container { display: flex; height: 100%; width: 100%; opacity: 0; visibility: hidden; transition: opacity 0.5s; }
        .app-container.visible { opacity: 1; visibility: visible; }
        #sidebar { width: 300px; background: var(--bg-secondary); padding: 20px; display: flex; flex-direction: column; border-right: 1px solid var(--bg-tertiary); }
        .sidebar-nav { flex-grow: 1; overflow-y: auto; }
        .sidebar-nav h3 { color: var(--text-secondary); font-size: 0.8em; text-transform: uppercase; letter-spacing: 1px; margin: 20px 0 10px 0; }
        .sidebar-nav button { background: var(--bg-tertiary); border: none; width: 100%; color: var(--text-primary); text-align: left; padding: 12px 15px; font-size: 1em; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 15px; transition: all 0.2s; font-family: var(--font-main); margin-bottom: 8px; }
        .sidebar-nav button:hover { background: var(--accent-primary); color: #121212; }
        
        .main-chat { flex: 1; display: flex; flex-direction: column; }
        #header { padding: 10px 20px; background: var(--bg-secondary); display: flex; align-items: center; gap: 15px; border-bottom: 1px solid var(--bg-tertiary); }
        #menu-toggle { background: none; border: none; color: var(--text-primary); font-size: 1.8em; cursor: pointer; display: none; }
        .header-title { text-align: center; flex-grow: 1; }
        .header-title h2, .header-title p { margin: 0; line-height: 1.2; } .header-title p { font-size: 0.8em; color: var(--text-secondary); }
        #messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
        .message { display: flex; align-items: flex-end; gap: 10px; max-width: 80%; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: 500; flex-shrink: 0; background: var(--bg-tertiary); }
        .bot .avatar.typing-avatar { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { background-color: var(--bg-tertiary); } 50% { background-color: var(--accent-secondary); } }
        .msg-content { padding: 15px 20px; border-radius: 20px; }
        .bot .msg-content { background: var(--bot-msg-bg); border-bottom-left-radius: 5px; }
        .user { align-self: flex-end; flex-direction: row-reverse; } .user .avatar { background: var(--accent-primary); } .user .msg-content { background: var(--user-msg-bg); color: white; border-bottom-right-radius: 5px; }
        
        #input-area { display: flex; gap: 10px; padding: 10px 20px; border-top: 1px solid var(--bg-tertiary); }
        #input { flex: 1; padding: 15px; border: none; outline: none; background: var(--bg-secondary); color: var(--text-primary); border-radius: 15px; font-size: 1em; font-family: var(--font-main); }
        #send { background: var(--accent-primary); border: none; padding: 15px; cursor: pointer; color: white; border-radius: 15px; }
        
        @media (max-width: 768px) {
            #sidebar { position: fixed; height: 100%; z-index: 1000; margin-left: -100%; width: 80%; }
            #sidebar.open { margin-left: 0; }
            #menu-toggle { display: block; }
        }
    </style>
</head>
<body>
    <div id="intro-overlay">
        <div class="intro-content">
            <h1>‚ú¶<span>Ôº≥œÉœÅ—í…™Œ±</span>‚ú¶</h1>
            <p>Sua assistente pessoal com mem√≥ria e aprendizado. Suas conversas e dados s√£o salvos localmente no seu navegador para total privacidade.</p>
            <div class="terms-container">
                <input type="checkbox" id="terms-checkbox">
                <label for="terms-checkbox">Eu li e aceito os <a href="https://naotodev1.github.io/terms-e-policy/" target="_blank">Termos de Uso e Pol√≠tica de Privacidade</a></label>
            </div>
            <button id="start-button" disabled>Come√ßar</button>
        </div>
    </div>

    <div class="app-container">
        <aside id="sidebar"></aside>
        <main id="main-chat">
            <div id="header">
                <button id="menu-toggle">&#9776;</button>
                <div class="header-title">
                    <h2 id="header-name">Sophia</h2>
                    <p id="header-subtitle">v11.2</p>
                </div>
            </div>
            <div id="messages"></div>
            <div id="input-area">
                <input type="text" id="input" placeholder="Digite sua mensagem..." />
                <button id="send">Enviar</button>
            </div>
        </main>
    </div>

    <script>
        // --- 1. CONFIGURA√á√ÉO E VARI√ÅVEIS GLOBAIS ---
        let appState = {};
        let domElements = {};

        // ‚ùó‚ùó‚ùó CHAVE DA API GNEWS AQUI ‚ùó‚ùó‚ùó
        const NEWS_API_KEY = 'SUA_CHAVE_DE_API_AQUI';

        // --- 2. MEM√ìRIA E ESTADO ---
        const defaultMemory = {
            botProfile: { name: 'Sophia', mode: 'sophia' },
            userProfile: { name: null, acceptedTerms: false },
            knowledge: { 'sophia': 'uma assistente virtual.' }
        };
        function loadMemory() {
            const saved = localStorage.getItem('SOPHIA_MEMORY_V11');
            appState.memory = saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(defaultMemory));
        }
        function saveMemory() {
            localStorage.setItem('SOPHIA_MEMORY_V11', JSON.stringify(appState.memory));
        }
        
        // --- 3. C√âREBRO (L√ìGICA PRINCIPAL) ---
        const brain = {
            getResponse: async function(userText) {
                const text = userText.toLowerCase();
                const { mode } = appState.memory.botProfile;

                // Comandos Globais
                if (text === 'ativar modo kai') return { response: 'RESPONSE_TYPE_KAI_ON' };
                if (text === 'sair do modo kai' || text === 'voltar para sophia') return { response: 'RESPONSE_TYPE_KAI_OFF' };
                const renameMatch = text.match(/^renomear para (.+)/);
                if (renameMatch) {
                    const newName = renameMatch[1].trim();
                    appState.memory.botProfile.name = newName;
                    saveMemory();
                    return { response: `Entendido. A partir de agora, meu nome √© **${newName}**.` };
                }
                const learnMatch = text.match(/^(?:lembre-se que|aprenda que) (.+?) (?:√©|sou|s√£o) (.+)/);
                if (learnMatch) return this.handleSemanticLearning(learnMatch);

                const personality = mode === 'kai' ? this.kai : this.sophia;
                return await personality.getResponse(text);
            },
            handleSemanticLearning: async (match) => {
                const term = match[1].trim().toLowerCase();
                const relationship = match[2].trim();
                appState.memory.knowledge[term] = relationship;
                saveMemory();
                return { response: `Entendido. Aprendi que **${term}** √© ${relationship}.` };
            },
            
            sophia: {
                getResponse: async function(text) {
                    const commands = [
                        { p: /^(?:o que significa|defina) (.+)/, h: this.getDefinition },
                        { p: /^not√≠cias(?: sobre (.+))?/, h: this.getNews },
                        { p: /^(?:o que √©|quem √©) (.+)\?/, h: this.getKnowledge },
                        { p: /^limpar mem√≥ria/, h: this.clearMemory },
                    ];
                    for (const cmd of commands) {
                        const match = text.match(cmd.p);
                        if (match) return await cmd.h(match);
                    }
                    if (text.includes('ajuda')) return { response: `Eu posso te ajudar com not√≠cias, defini√ß√µes e mais. Para um ambiente t√©cnico, tente \`ativar modo kai\`.` };
                    if (text.includes('oi')||text.includes('ol√°')) return { response: `Ol√°, ${appState.memory.userProfile.name || 'usu√°rio'}!` };
                    return { response: "N√£o entendi. Tente 'ajuda' para ver os comandos." };
                },
                getNews: async (match) => {
                    if (!NEWS_API_KEY || NEWS_API_KEY === 'SUA_CHAVE_DE_API_AQUI') return { response: "‚ùå A fun√ß√£o de not√≠cias est√° desativada." };
                    const query = match[1] || 'general';
                    try {
                        const response = await fetch(`https://gnews.io/api/v4/top-headlines?lang=pt&topic=${encodeURIComponent(query)}&token=${NEWS_API_KEY}`);
                        const data = await response.json();
                        let html = `Aqui est√£o as 3 principais not√≠cias sobre **${query}**:\n`;
                        data.articles.slice(0, 3).forEach(article => { html += `<div class="api-card" style="display:flex;gap:10px;margin-top:10px;"><img src="${article.image}" style="width:60px;height:60px;object-fit:cover;border-radius:5px;"><div style="display:flex;flex-direction:column;"><strong>${article.title}</strong><a href="${article.url}" target="_blank" style="color:var(--accent-secondary);text-decoration:none;">Ler mais</a></div></div>`; });
                        return { response: html };
                    } catch (e) { return { response: `‚ùå N√£o consegui buscar as not√≠cias.` }; }
                },
                getDefinition: async (match) => {
                    const word = match[1].trim();
                    try {
                        const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/pt-BR/${encodeURIComponent(word)}`);
                        const data = await response.json();
                        const meaning = data[0].meanings[0].definitions[0];
                        return { response: `**${word.charAt(0).toUpperCase() + word.slice(1)}**: ${meaning.definition}` };
                    } catch (e) { return { response: `N√£o encontrei uma defini√ß√£o para "${word}".` }; }
                },
                getKnowledge: async (match) => {
                    const concept = match[1].trim();
                    const knowledge = appState.memory.knowledge[concept];
                    return { response: knowledge ? `Pelo que aprendi, **${concept}** √© ${knowledge}.` : `Ainda n√£o aprendi sobre **${concept}` };
                },
                clearMemory: async () => {
                    if (confirm("Voc√™ tem certeza que quer excluir todos os seus dados?")) {
                        localStorage.removeItem('SOPHIA_MEMORY_V11'); loadMemory();
                        return { response: "Mem√≥ria limpa. Come√ßando do zero." };
                    } return { response: "A√ß√£o cancelada." };
                },
            },
            kai: {
                getResponse: async function(text) {
                    if (text.includes('ajuda')) return { response: "Comandos KAI: `gere um html b√°sico`, `doc javascript [t√≥pico]`. Diga `sair do modo kai` para voltar." };
                    if (text.includes('oi')) return { response: `Sistemas online. Diretiva?` };
                    return { response: "Comando n√£o reconhecido no modo KAI." };
                }
            }
        };

        // --- 4. M√ìDULO DE UI ---
        const UI = {
            initApp: function() {
                // Associa todos os elementos do DOM da tela principal
                domElements.sidebar = document.getElementById('sidebar');
                domElements.menuToggle = document.getElementById('menu-toggle');
                domElements.messagesContainer = document.getElementById("messages");
                domElements.inputField = document.getElementById("input");
                domElements.sendButton = document.getElementById("send");
                domElements.headerName = document.getElementById('header-name');
                domElements.headerSubtitle = document.getElementById('header-subtitle');

                // Anexa os eventos principais
                domElements.menuToggle.addEventListener('click', () => domElements.sidebar.classList.toggle('open'));
                domElements.sendButton.addEventListener('click', () => handleSend());
                domElements.inputField.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSend(); });
            },
            startApp: function() {
                appState.memory.userProfile.acceptedTerms = true;
                if (!appState.memory.userProfile.name) {
                    const name = prompt("Bem-vindo(a)! Como posso te chamar?");
                    if (name) appState.memory.userProfile.name = name;
                }
                saveMemory();
                
                domElements.introOverlay.style.opacity = '0';
                setTimeout(() => {
                    domElements.introOverlay.style.display = 'none';
                    domElements.appContainer.classList.add('visible');
                    UI.initApp(); // INICIALIZA A UI PRINCIPAL S√ì AGORA
                    UI.renderSidebar();
                    UI.updateHeader();
                    UI.addMessage(`Ol√°, ${appState.memory.userProfile.name || 'usu√°rio'}! Explore o menu para ver o que posso fazer.`, 'bot');
                }, 500);
            },
            renderSidebar: function() {
                domElements.sidebar.innerHTML = `
                    <div class="sidebar-header"><h2 id="sidebar-name">‚ú¶<span>SOPHIA</span>‚ú¶</h2></div>
                    <nav class="sidebar-nav">
                        <h3>Funcionalidades</h3>
                        <button data-command="not√≠cias">üì∞ Not√≠cias</button>
                        <button data-command="o que significa...">üìñ Dicion√°rio</button>
                        <h3>Conta</h3>
                        <button onclick="UI.exportData()">üì• Exportar Dados</button>
                        <button onclick="UI.deleteAccount()">‚ùå Excluir Conta</button>
                        <hr style="border-color: var(--bg-tertiary); margin: 15px 0;">
                        <button id="kai-mode-btn" data-command="kai">üöÄ Ativar Modo KAI</button>
                    </nav>
                `;
                domElements.sidebar.querySelectorAll('button[data-command]').forEach(btn => {
                    btn.addEventListener('click', () => handleSend(btn.dataset.command));
                });
            },
            updateHeader: function() {
                domElements.headerName.innerText = appState.memory.botProfile.name;
                domElements.headerSubtitle.innerText = `Modo ${appState.memory.botProfile.mode}`;
            },
            addMessage: function(text, sender) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
                const avatarChar = sender === 'user' ? (appState.memory.userProfile.name ? appState.memory.userProfile.name.charAt(0).toUpperCase() : 'U') : (appState.memory.botProfile.mode === 'kai' ? 'K' : appState.memory.botProfile.name.charAt(0).toUpperCase());
                messageDiv.innerHTML = `<div class="avatar">${avatarChar}</div><div class="msg-content">${text.replace(/\n/g, '<br>')}</div>`;
                domElements.messagesContainer.appendChild(messageDiv);
                domElements.messagesContainer.scrollTop = domElements.messagesContainer.scrollHeight;
            },
            exportData: function() { /* ...l√≥gica da v11... */ },
            deleteAccount: function() { /* ...l√≥gica da v11... */ }
        };
        
        // --- 5. INICIALIZA√á√ÉO E FLUXO PRINCIPAL ---
        window.onload = () => {
            // Associa apenas os elementos da tela de in√≠cio
            domElements.introOverlay = document.getElementById('intro-overlay');
            domElements.termsCheckbox = document.getElementById('terms-checkbox');
            domElements.startButton = document.getElementById('start-button');
            domElements.appContainer = document.getElementById('app-container');

            loadMemory();
            
            if (appState.memory.userProfile.acceptedTerms) {
                UI.startApp();
            } else {
                domElements.termsCheckbox.addEventListener('change', () => { domElements.startButton.disabled = !domElements.termsCheckbox.checked; });
                domElements.startButton.addEventListener('click', UI.startApp);
            }
        };

        async function handleSend(prefilledText) {
            const userText = typeof prefilledText === 'string' ? prefilledText : inputField.value.trim();
            if (!userText) return;

            UI.addMessage(userText, 'user');
            if (typeof prefilledText !== 'string') inputField.value = '';
            
            const botPayload = await brain.getResponse(userText);
            
            // L√≥gica para tratar respostas especiais (troca de modo, etc.)
            if (botPayload.response === 'RESPONSE_TYPE_KAI_ON') {
                appState.memory.botProfile.mode = 'kai'; saveMemory(); UI.updateHeader();
                document.body.classList.add('kai-theme');
                UI.addMessage("Modo KAI ativado.", 'bot');
            } else if (botPayload.response === 'RESPONSE_TYPE_KAI_OFF') {
                appState.memory.botProfile.mode = 'sophia'; saveMemory(); UI.updateHeader();
                document.body.classList.remove('kai-theme');
                UI.addMessage("Retornando para a interface da Sophia.", 'bot');
            } else {
                UI.addMessage(botPayload.response, 'bot');
            }
        }

        // --- REGISTRO DO SERVICE WORKER (PWA) ---
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('service-worker.js')
              .then(reg => console.log('Service Worker Registrado'))
              .catch(err => console.log('Service Worker: Erro', err));
          });
        }
    </script>
</body>
</html>
